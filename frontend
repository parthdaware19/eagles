<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WorldSim ‚Äî Realm Resource Engine</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Cinzel:wght@400;600;700;900&family=Rajdhani:wght@300;400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#060810; --bg2:#080b14; --panel:#0b1020; --panel2:#0f1628;
  --border:#18263a; --border2:#22344e;
  --gold:#c8a84a; --gold2:#f0cc6a; --gold3:#ffeaa0;
  --water:#38b4f0; --food:#5ed468; --energy:#f5c830; --land:#c8784a;
  --danger:#e84848; --warn:#f09030; --ok:#5ed468;
  --dim:#304458; --text:#c0d0e0; --text2:#8aaac0;
  --north:#7ab0e8; --west:#d07840; --valyria:#b870e0; --river:#58d068; --iron:#7888b0;
  --r:10px; --r2:6px;
  --font-display:'Cinzel Decorative',serif;
  --font-ui:'Cinzel',serif;
  --font-body:'Rajdhani',sans-serif;
  --font-mono:'Share Tech Mono',monospace;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{width:100%;height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:var(--font-body);font-size:14px;display:flex;flex-direction:column;}

/* scanlines */
body::after{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,0.08) 3px,rgba(0,0,0,0.08) 4px);pointer-events:none;z-index:9999;}

/* ‚ïê‚ïê TOPBAR ‚ïê‚ïê */
.topbar{
  display:flex;align-items:center;gap:20px;padding:11px 24px;
  background:linear-gradient(90deg,#06080e 0%,#0e1828 50%,#06080e 100%);
  border-bottom:1px solid var(--border2);flex-shrink:0;position:relative;z-index:100;
}
.topbar::before{content:'';position:absolute;bottom:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent 0%,var(--gold) 40%,var(--gold2) 50%,var(--gold) 60%,transparent 100%);}
.topbar::after{content:'';position:absolute;bottom:-3px;left:25%;right:25%;height:1px;
  background:linear-gradient(90deg,transparent,rgba(201,168,76,0.3),transparent);}

.logo{
  font-family:var(--font-display);font-size:16px;font-weight:900;
  color:var(--gold2);letter-spacing:0.15em;
  text-shadow:0 0 30px rgba(201,168,76,0.5),0 0 60px rgba(201,168,76,0.2);
  white-space:nowrap;flex-shrink:0;
}
.logo small{font-family:var(--font-mono);font-size:9px;color:var(--dim);letter-spacing:0.2em;display:block;margin-top:2px;font-weight:400;}

.tbar-divider{width:1px;height:32px;background:var(--border2);flex-shrink:0;}

.topbar-stats{display:flex;gap:6px;flex:1;justify-content:center;}
.tstat{
  text-align:center;padding:6px 14px;
  background:rgba(0,0,0,0.3);border:1px solid var(--border);border-radius:var(--r2);
  transition:border-color 0.3s;
}
.tstat:hover{border-color:var(--border2);}
.tstat-val{font-family:var(--font-ui);font-size:18px;font-weight:700;color:var(--gold2);line-height:1;letter-spacing:0.05em;}
.tstat-lbl{font-family:var(--font-mono);color:var(--dim);font-size:9px;letter-spacing:0.15em;margin-top:3px;text-transform:uppercase;}

.controls{display:flex;gap:8px;align-items:center;flex-shrink:0;}
.btn{
  font-family:var(--font-ui);font-size:10px;font-weight:700;letter-spacing:0.12em;
  padding:9px 18px;border:1px solid var(--border2);border-radius:var(--r2);
  background:rgba(0,0,0,0.4);color:var(--text2);cursor:pointer;transition:all 0.2s;white-space:nowrap;
}
.btn:hover{border-color:var(--gold);color:var(--gold);background:rgba(201,168,76,0.05);}
.btn.primary{
  background:linear-gradient(135deg,rgba(42,30,0,0.9),rgba(80,56,0,0.9));
  border-color:var(--gold);color:var(--gold2);
  box-shadow:0 0 8px rgba(201,168,76,0.15);
}
.btn.primary:hover{box-shadow:0 0 16px rgba(201,168,76,0.35);color:var(--gold3);}
.btn.danger{border-color:rgba(232,72,72,0.5);color:var(--danger);}
.btn.danger:hover{background:rgba(232,72,72,0.08);border-color:var(--danger);}
.spd{font-family:var(--font-ui);font-size:12px;color:var(--warn);font-weight:700;letter-spacing:0.1em;}

/* ‚ïê‚ïê LAYOUT ‚ïê‚ïê */
.main{display:grid;grid-template-columns:440px 1fr;flex:1;overflow:hidden;min-height:0;}

/* ‚îÄ‚îÄ LEFT PANEL ‚îÄ‚îÄ */
.leftwrap{display:flex;flex-direction:column;overflow:hidden;border-right:1px solid var(--border);}

.tabs{display:flex;border-bottom:1px solid var(--border);background:var(--panel);flex-shrink:0;}
.tab{
  flex:1;padding:11px 8px;font-family:var(--font-ui);font-size:10px;font-weight:700;
  letter-spacing:0.1em;cursor:pointer;color:var(--dim);transition:all 0.2s;
  border-bottom:2px solid transparent;text-align:center;
}
.tab:hover{color:var(--text2);}
.tab.active{color:var(--gold2);border-bottom-color:var(--gold);background:rgba(201,168,76,0.03);}

.tab-content{flex:1;overflow:hidden;display:none;min-height:0;}
.tab-content.active{display:flex;flex-direction:column;overflow-y:auto;}
.tab-content::-webkit-scrollbar{width:4px;}
.tab-content::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
.tab-content::-webkit-scrollbar-track{background:transparent;}

/* ‚îÄ‚îÄ REALM CARDS ‚îÄ‚îÄ */
.ov-wrap{padding:14px;display:flex;flex-direction:column;gap:12px;}

.realm-card{
  background:linear-gradient(135deg,var(--panel2) 0%,rgba(10,14,24,0.95) 100%);
  border:1px solid var(--border);border-radius:var(--r);
  padding:14px;cursor:pointer;transition:all 0.25s;
  position:relative;overflow:hidden;
}
.realm-card::before{
  content:'';position:absolute;top:0;left:0;right:0;height:3px;
  background:linear-gradient(90deg,transparent,var(--rc),transparent);
}
.realm-card::after{
  content:'';position:absolute;top:0;left:0;bottom:0;width:3px;
  background:var(--rc,transparent);opacity:0.7;
}
.realm-card:hover{border-color:var(--border2);transform:translateX(2px);}
.realm-card.sel{border-color:rgba(201,168,76,0.5);background:linear-gradient(135deg,rgba(15,20,36,0.98),rgba(12,16,28,0.98));}
.realm-card.sel::before{opacity:1;}
.realm-card.collapsed{border-color:rgba(232,72,72,0.25);opacity:0.8;}
.realm-card.regrow{border-color:rgba(94,212,104,0.35);animation:regrowPulse 2s ease infinite;}
.realm-card.struggle{border-color:rgba(240,144,48,0.35);}

@keyframes regrowPulse{0%,100%{box-shadow:0 0 0 rgba(94,212,104,0)}50%{box-shadow:0 0 12px rgba(94,212,104,0.15)}}

.rc-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;}
.rc-name-wrap{}
.rc-name{font-family:var(--font-ui);font-size:15px;font-weight:700;letter-spacing:0.08em;margin-bottom:3px;}
.rc-phase{font-family:var(--font-mono);font-size:10px;letter-spacing:0.1em;padding:2px 8px;border-radius:3px;}
.rc-right{text-align:right;}
.rc-strat{font-family:var(--font-mono);font-size:10px;padding:3px 9px;border-radius:3px;letter-spacing:0.06em;display:inline-block;margin-bottom:4px;}
.rc-econ{font-family:var(--font-ui);font-size:22px;font-weight:900;color:var(--gold2);line-height:1;}
.rc-delta{font-family:var(--font-body);font-size:12px;color:var(--dim);margin-top:2px;}

/* RESOURCE BARS ‚Äî beautiful */
.res-bars{display:flex;flex-direction:column;gap:7px;margin-bottom:10px;}
.res-bar-row{display:flex;align-items:center;gap:8px;}
.res-icon{font-size:14px;width:20px;text-align:center;flex-shrink:0;}
.res-label{font-family:var(--font-mono);font-size:10px;color:var(--dim);width:44px;letter-spacing:0.06em;flex-shrink:0;}
.res-track{flex:1;position:relative;height:8px;background:rgba(255,255,255,0.04);border-radius:4px;overflow:hidden;}
.res-fill{
  height:100%;border-radius:4px;transition:width 0.6s cubic-bezier(0.4,0,0.2,1);
  position:relative;
}
.res-fill::after{
  content:'';position:absolute;top:0;left:0;right:0;height:50%;
  background:rgba(255,255,255,0.15);border-radius:4px 4px 0 0;
}
.res-segments{position:absolute;top:0;left:0;right:0;bottom:0;display:flex;}
.res-seg{flex:1;border-right:1px solid rgba(0,0,0,0.3);}
.res-seg:last-child{border:none;}
.res-val{font-family:var(--font-ui);font-size:12px;font-weight:600;width:30px;text-align:right;flex-shrink:0;}
.res-trend{font-size:10px;width:14px;text-align:center;flex-shrink:0;}

/* rc footer */
.rc-footer{display:flex;gap:8px;align-items:center;padding-top:8px;border-top:1px solid var(--border);}
.rc-stat{font-family:var(--font-body);font-size:12px;color:var(--dim);display:flex;align-items:center;gap:4px;}
.rc-stat span{color:var(--text2);}

/* ‚îÄ‚îÄ RESOURCE GRID TAB ‚îÄ‚îÄ */
.rg-wrap{padding:14px;display:flex;flex-direction:column;gap:14px;}
.rg-realm{
  background:var(--panel2);border:1px solid var(--border);
  border-radius:var(--r);overflow:hidden;
}
.rg-header{
  padding:10px 14px;display:flex;justify-content:space-between;align-items:center;
  border-bottom:1px solid var(--border);
  background:linear-gradient(90deg,rgba(0,0,0,0.3),transparent);
}
.rg-hname{font-family:var(--font-ui);font-size:13px;font-weight:700;letter-spacing:0.1em;}
.rg-hecon{font-family:var(--font-ui);font-size:16px;font-weight:900;color:var(--gold2);}
.rg-body{padding:12px 14px;}
.rg-res-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;}
.rg-res-box{
  background:rgba(0,0,0,0.25);border:1px solid var(--border);
  border-radius:var(--r2);padding:10px;
}
.rg-res-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.rg-res-icon{font-size:18px;}
.rg-res-name{font-family:var(--font-mono);font-size:10px;color:var(--dim);letter-spacing:0.1em;}
.rg-res-val{font-family:var(--font-ui);font-size:22px;font-weight:900;line-height:1;}
.rg-res-bar{height:6px;background:rgba(255,255,255,0.05);border-radius:3px;overflow:hidden;margin-top:6px;}
.rg-res-fill{height:100%;border-radius:3px;transition:width 0.6s ease;}
.rg-factors{display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px;}
.rg-factor{
  background:rgba(0,0,0,0.3);border:1px solid var(--border);
  border-radius:4px;padding:6px 8px;
  display:flex;justify-content:space-between;align-items:center;
  font-size:11px;
}
.rg-f-name{color:var(--text2);font-family:var(--font-body);}
.rg-f-val{font-family:var(--font-ui);font-size:12px;font-weight:700;}
.rg-f-val.pos{color:var(--ok);}
.rg-f-val.neg{color:var(--danger);}
.rg-f-val.neu{color:var(--gold);}

/* ‚îÄ‚îÄ RANKING TAB ‚îÄ‚îÄ */
.rank-wrap{padding:14px;display:flex;flex-direction:column;gap:14px;}
.rank-table{width:100%;border-collapse:collapse;}
.rank-table th{
  font-family:var(--font-ui);font-size:10px;letter-spacing:0.15em;
  padding:10px 8px;text-align:left;color:var(--gold);
  border-bottom:1px solid var(--border2);
  background:rgba(0,0,0,0.5);text-transform:uppercase;
}
.rank-table td{padding:10px 8px;border-bottom:1px solid var(--border);vertical-align:middle;}
.rank-table tr:hover td{background:rgba(201,168,76,0.03);}
.rnum{font-family:var(--font-display);font-size:20px;font-weight:900;text-align:center;}
.rnum.r1{color:#ffd700;text-shadow:0 0 12px rgba(255,215,0,0.4);}
.rnum.r2{color:#c8c8c8;}
.rnum.r3{color:#d08040;}
.rnum.rn{color:var(--dim);}
.rbadge{display:flex;align-items:center;gap:7px;}
.rdot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.rname{font-family:var(--font-ui);font-size:12px;font-weight:700;}
.rpts{font-family:var(--font-ui);font-size:16px;font-weight:700;}
.rdelta{font-size:12px;font-family:var(--font-body);}
.rbar-wrap{width:100px;}
.rbar-bg{height:12px;background:rgba(255,255,255,0.04);border-radius:6px;overflow:hidden;}
.rbar-fg{height:100%;border-radius:6px;transition:width 0.6s ease;display:flex;align-items:center;justify-content:flex-end;padding-right:4px;}
.rbar-label{font-family:var(--font-ui);font-size:8px;font-weight:700;color:rgba(0,0,0,0.8);}
.rstatus{font-family:var(--font-body);font-size:12px;font-weight:600;}

/* RP Legend */
.rp-card{background:var(--panel2);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;}
.rp-hd{font-family:var(--font-ui);font-size:11px;font-weight:700;letter-spacing:0.15em;color:var(--gold);padding:10px 14px;border-bottom:1px solid var(--border);background:rgba(0,0,0,0.4);}
.rp-grid{display:grid;grid-template-columns:1fr 1fr;gap:0;}
.rp-row{display:flex;align-items:center;gap:8px;font-size:12px;padding:8px 14px;border-bottom:1px solid var(--border);}
.rp-row:nth-child(odd){border-right:1px solid var(--border);}
.rp-row:last-child,.rp-row:nth-last-child(2):nth-child(odd){border-bottom:none;}
.rp-icon{font-size:15px;width:22px;text-align:center;}
.rp-name{flex:1;color:var(--text2);font-family:var(--font-body);}
.rp-pts{font-family:var(--font-ui);font-size:13px;font-weight:700;}

/* ‚îÄ‚îÄ ANALYSIS TAB ‚îÄ‚îÄ */
.ana-wrap{padding:14px;display:flex;flex-direction:column;gap:12px;}
.ins-card{background:var(--panel2);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;}
.ins-hd{
  font-family:var(--font-ui);font-size:11px;font-weight:700;letter-spacing:0.12em;
  color:var(--gold);padding:10px 14px;border-bottom:1px solid var(--border);
  background:linear-gradient(90deg,rgba(201,168,76,0.06),transparent);
  display:flex;align-items:center;gap:8px;
}
.ins-bd{padding:14px;font-family:var(--font-body);font-size:13px;line-height:1.8;color:var(--text2);}
.ins-bd em{color:var(--gold2);font-style:normal;font-weight:600;}
.ins-bd .highlight{color:var(--text);font-weight:600;}

/* ‚îÄ‚îÄ MAP (RIGHT) ‚îÄ‚îÄ */
.mapwrap{display:flex;flex-direction:column;overflow:hidden;min-height:0;position:relative;}
.map-topbar{
  display:flex;align-items:center;justify-content:space-between;
  padding:9px 18px;border-bottom:1px solid var(--border);
  background:var(--panel);flex-shrink:0;
}
.map-title{font-family:var(--font-ui);font-size:13px;font-weight:700;color:var(--gold);letter-spacing:0.12em;}
.map-status{display:flex;gap:16px;font-family:var(--font-mono);font-size:10px;color:var(--dim);}
.map-status span{display:flex;align-items:center;gap:5px;}
.status-dot{width:7px;height:7px;border-radius:50%;animation:pulse 1.5s infinite;}

#worldCanvas{flex:1;width:100%;display:block;min-height:0;}

/* Info bar below canvas */
.map-infobar{
  display:grid;grid-template-columns:1fr 1.6fr 1.2fr;gap:0;
  border-top:1px solid var(--border);flex-shrink:0;
  background:var(--panel);max-height:130px;
}
.mib-section{padding:10px 14px;border-right:1px solid var(--border);}
.mib-section:last-child{border:none;}
.mib-title{font-family:var(--font-ui);font-size:9px;font-weight:700;letter-spacing:0.18em;color:var(--gold);margin-bottom:7px;text-transform:uppercase;}
.mib-body{font-family:var(--font-body);font-size:11px;line-height:1.6;color:var(--dim);overflow-y:auto;max-height:90px;}
.mib-body::-webkit-scrollbar{width:2px;}
.mib-body::-webkit-scrollbar-thumb{background:var(--border2);}

.al-chip{
  display:inline-flex;align-items:center;gap:5px;
  background:rgba(184,112,224,0.08);border:1px solid rgba(184,112,224,0.2);
  border-radius:4px;padding:3px 8px;margin:2px 3px 2px 0;
  font-size:11px;font-family:var(--font-body);
}

/* Event log */
.evlog{
  height:90px;overflow-y:auto;background:var(--bg);
  border-top:1px solid var(--border);padding:8px 18px;flex-shrink:0;
}
.evlog::-webkit-scrollbar{width:3px;}
.evlog::-webkit-scrollbar-thumb{background:var(--border2);}
.log-entry{display:flex;gap:10px;font-size:11px;line-height:1.75;animation:fadeIn 0.2s ease;font-family:var(--font-mono);}
.log-time{color:var(--dim);flex-shrink:0;font-size:10px;letter-spacing:0.05em;}
.lt{color:var(--food);}   /* trade */
.lc{color:var(--danger);}  /* conflict */
.lm{color:var(--warn);}    /* climate */
.lg{color:var(--ok);}      /* growth */
.la{color:var(--valyria);}  /* alliance */
.li{color:var(--dim);}      /* info */
.ls{color:var(--warn);}     /* struggle */
.lr{color:#a0e870;}         /* regrowth */

@keyframes fadeIn{from{opacity:0;transform:translateY(3px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.4;transform:scale(0.75)}}
@keyframes growIn{from{transform:scaleX(0)}to{transform:scaleX(1)}}
</style>
</head>
<body>

<!-- ‚ïê‚ïê TOPBAR ‚ïê‚ïê -->
<div class="topbar">
  <div class="logo">WORLDSIM<small>REALM RESOURCE ENGINE v5.0</small></div>
  <div class="tbar-divider"></div>
  <div class="topbar-stats">
    <div class="tstat"><div class="tstat-val" id="t-cycle">0</div><div class="tstat-lbl">CYCLE</div></div>
    <div class="tstat"><div class="tstat-val" id="t-active" style="color:var(--ok)">5</div><div class="tstat-lbl">ACTIVE</div></div>
    <div class="tstat"><div class="tstat-val" id="t-coll" style="color:var(--danger)">0</div><div class="tstat-lbl">COLLAPSED</div></div>
    <div class="tstat"><div class="tstat-val" id="t-regrow" style="color:#a0e870">0</div><div class="tstat-lbl">REGROWN</div></div>
    <div class="tstat"><div class="tstat-val" id="t-trades" style="color:var(--food)">0</div><div class="tstat-lbl">TRADES</div></div>
    <div class="tstat"><div class="tstat-val" id="t-alliances" style="color:var(--valyria)">0</div><div class="tstat-lbl">ALLIANCES</div></div>
    <div class="tstat"><div class="tstat-val" id="t-leader" style="font-size:13px;letter-spacing:0.05em">‚Äî</div><div class="tstat-lbl">LEADING</div></div>
  </div>
  <div class="tbar-divider"></div>
  <div class="controls">
    <span class="spd" id="speed-lbl">1√ó</span>
    <button class="btn" onclick="cycleSpeed()">‚è© SPEED</button>
    <button class="btn primary" id="btn-start" onclick="toggleSim()">‚ñ∂ BEGIN</button>
    <button class="btn danger" onclick="resetSim()">‚Ü∫ RESET</button>
  </div>
</div>

<!-- ‚ïê‚ïê MAIN ‚ïê‚ïê -->
<div class="main">

  <!-- LEFT: tabbed panels -->
  <div class="leftwrap">
    <div class="tabs">
      <div class="tab active" onclick="showTab('overview',this)">üëë REALMS</div>
      <div class="tab" onclick="showTab('resgrid',this)">üìä RESOURCES</div>
      <div class="tab" onclick="showTab('ranking',this)">üèÜ RANKING</div>
      <div class="tab" onclick="showTab('analysis',this)">üî¨ ANALYSIS</div>
    </div>

    <!-- OVERVIEW -->
    <div class="tab-content active" id="tab-overview">
      <div class="ov-wrap" id="ov-cards"></div>
    </div>

    <!-- RESOURCE GRID -->
    <div class="tab-content" id="tab-resgrid">
      <div class="rg-wrap" id="rg-inner"></div>
    </div>

    <!-- RANKING -->
    <div class="tab-content" id="tab-ranking">
      <div class="rank-wrap">
        <table class="rank-table">
          <thead><tr>
            <th>#</th><th>REALM</th><th>ECONOMY</th><th>BAR</th>
            <th>Œî/CYC</th><th>üíß</th><th>üåæ</th><th>‚ö°</th><th>üó∫</th>
            <th>TRADES</th><th>ALLIES</th><th>PHASE</th>
          </tr></thead>
          <tbody id="rank-body"></tbody>
        </table>
        <div class="rp-card">
          <div class="rp-hd">‚öñ REWARDS & PENALTIES SYSTEM</div>
          <div class="rp-grid" id="rp-legend"></div>
        </div>
      </div>
    </div>

    <!-- ANALYSIS -->
    <div class="tab-content" id="tab-analysis">
      <div class="ana-wrap" id="ana-inner">
        <div class="ins-card"><div class="ins-bd" style="padding:20px;color:var(--dim);font-size:13px">Start the simulation to generate strategic analysis...</div></div>
      </div>
    </div>
  </div>

  <!-- RIGHT: big map -->
  <div class="mapwrap">
    <div class="map-topbar">
      <div class="map-title">üó∫ WORLD MAP ‚Äî LIVE SIMULATION ENGINE</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="btn-graph" onclick="toggleGraph()" style="padding:5px 12px;font-size:9px">üìà SHOW GRAPH</button>
      </div>
      <div class="map-status">
        <span><span class="status-dot" style="background:var(--ok)" id="sim-dot"></span><span id="sim-status-lbl">STANDBY</span></span>
        <span id="climate-badge" style="color:var(--ok)">‚òÄ CLIMATE: STABLE</span>
        <span id="map-cycle-lbl" style="color:var(--gold)">CYC 0</span>
      </div>
    </div>
    <canvas id="worldCanvas"></canvas>
    <!-- GRAPH OVERLAY -->
    <div id="graph-overlay" style="display:none;position:absolute;top:44px;left:0;right:0;bottom:230px;background:rgba(6,8,16,0.97);z-index:50;flex-direction:column;padding:16px 20px;overflow:hidden;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-shrink:0;">
        <div style="font-family:var(--font-ui);font-size:13px;font-weight:700;color:var(--gold);letter-spacing:0.12em;">üìà ECONOMY POINTS ‚Äî LIVE CHART</div>
        <div style="display:flex;gap:12px;flex-wrap:wrap;" id="graph-legend"></div>
      </div>
      <div style="flex:1;position:relative;min-height:0;">
        <canvas id="graphCanvas" style="width:100%;height:100%;display:block;"></canvas>
      </div>
      <div style="display:flex;gap:24px;margin-top:10px;flex-shrink:0;flex-wrap:wrap;" id="graph-stats"></div>
    </div>
    <div class="map-infobar">
      <div class="mib-section">
        <div class="mib-title">Active Alliances</div>
        <div class="mib-body" id="mib-alliances">No alliances formed yet</div>
      </div>
      <div class="mib-section">
        <div class="mib-title">Q-Learning ‚Äî Selected Realm</div>
        <div class="mib-body" id="mib-qtable">Click a realm on the map to inspect</div>
      </div>
      <div class="mib-section">
        <div class="mib-title">Emergent Behaviors</div>
        <div class="mib-body" id="mib-behaviors">Observing patterns...</div>
      </div>
    </div>
    <div class="evlog" id="evlog">
      <div class="log-entry"><span class="log-time">[000]</span><span class="li">WorldSim v5 initialized ‚Äî all realms can collapse, learn, and regrow. Press BEGIN.</span></div>
    </div>
  </div>

</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WORLDSIM v5 ‚Äî COLLAPSE + REGROWTH ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const REALM_DEFS = [
  {id:0,name:'THE NORTH',  short:'NORTH', color:'#7ab0e8',x:0.18,y:0.18,r:{water:80,food:40,energy:50,land:75}},
  {id:1,name:'WESTERLANDS',short:'WEST',  color:'#d07840',x:0.20,y:0.66,r:{water:45,food:58,energy:88,land:62}},
  {id:2,name:'VALYRIA',    short:'VAL',   color:'#b870e0',x:0.55,y:0.22,r:{water:52,food:48,energy:82,land:42}},
  {id:3,name:'RIVERLANDS', short:'RIVER', color:'#58d068',x:0.62,y:0.66,r:{water:88,food:78,energy:42,land:72}},
  {id:4,name:'IRON ISLANDS',short:'IRON', color:'#7888b0',x:0.82,y:0.40,r:{water:38,food:62,energy:55,land:32}},
];

// PHASE: 'thriving'|'stable'|'struggling'|'critical'|'collapsed'|'regrowth'
const FACTORS = [
  {id:'food',   name:'Food Surplus',    icon:'üåæ',compute:r=>r.res.food-40,       pts:v=>v>20?15:v>0?8:v>-15?-4:-14},
  {id:'water',  name:'Water Access',    icon:'üíß',compute:r=>r.res.water,          pts:v=>v>70?12:v>40?6:v>20?-3:-12},
  {id:'energy', name:'Energy Output',   icon:'‚ö°',compute:r=>r.res.energy,         pts:v=>v>75?14:v>50?7:v>25?0:-8},
  {id:'land',   name:'Land Control',    icon:'üó∫',compute:r=>r.res.land,           pts:v=>v>70?10:v>45?5:v>20?0:-6},
  {id:'trade',  name:'Trade Bonus',     icon:'ü§ù',compute:r=>r.tradeCount,         pts:v=>Math.min(v*6,40)},
  {id:'ally',   name:'Alliance Bonus',  icon:'üõ°',compute:r=>r.allianceCount,      pts:v=>v*18},
  {id:'conflict',name:'Conflict Pen.',  icon:'‚öî',compute:r=>r.conflictCount,      pts:v=>-(v*6)},
  {id:'stability',name:'Stability',     icon:'‚öñ',compute:r=>Math.min(100,Math.max(0,(r.res.food+r.res.water)/2-r.conflictCount*4)),pts:v=>v>70?12:v>45?6:v>20?0:-8},
  {id:'growth', name:'Pop. Growth',     icon:'üìà',compute:r=>r.population-50,      pts:v=>Math.floor(v/10)*4},
  {id:'climate',name:'Climate Hits',    icon:'üå°',compute:r=>-r.climateHits,       pts:v=>v*4},
  {id:'conserve',name:'Conservation',   icon:'üå±',compute:r=>r.conserveCount,      pts:v=>v*3},
  {id:'expand', name:'Expansion',       icon:'üè∞',compute:r=>r.expandCount,        pts:v=>v*5},
];

const RP_LEGEND = [
  {icon:'ü§ù',name:'Successful Trade',pts:'+6‚Äì12',pos:true},
  {icon:'üõ°',name:'Alliance Formed',  pts:'+18',  pos:true},
  {icon:'üåæ',name:'Food Surplus',     pts:'+15',  pos:true},
  {icon:'üíß',name:'Water Abundance',  pts:'+12',  pos:true},
  {icon:'‚ö°',name:'High Energy',      pts:'+14',  pos:true},
  {icon:'üå±',name:'Conservation',     pts:'+3/act',pos:true},
  {icon:'üè∞',name:'Expansion',        pts:'+5/act',pos:true},
  {icon:'üìà',name:'Pop. Growth',      pts:'+4/10', pos:true},
  {icon:'‚öî',name:'Raid/Conflict',    pts:'‚àí6/act',pos:false},
  {icon:'üíÄ',name:'Collapse Penalty', pts:'‚àí40',   pos:false},
  {icon:'üå°',name:'Climate Hit',      pts:'‚àí4/hit',pos:false},
  {icon:'üíß',name:'Water Shortage',   pts:'‚àí12',   pos:false},
  {icon:'üìâ',name:'Alliance Broken',  pts:'‚àí12 ea',pos:false},
  {icon:'üîÑ',name:'Regrowth Bonus',   pts:'+20',   pos:true},
];

const ACTS = ['CONSERVE','TRADE','EXPAND','RAID','ALLY'];
const AICO = ['üå±','ü§ù','üè∞','‚öî','üõ°'];

let S = {};

function mkRegion(d) {
  return {
    ...d,
    res:{...d.r},
    prevRes:{...d.r},
    population: 55+Math.floor(Math.random()*30),
    phase:'stable',
    alive:true,
    age:0,
    collapseCount:0,
    regrowthCount:0,
    collapseCycle:0,
    regrowthCycle:0,
    econPts:100,
    econDelta:0,
    // Q-table: 4 states √ó 5 actions
    q: Array(4).fill(null).map(()=>ACTS.map((_,i)=>[0.15,0.30,0.20,0.10,0.18][i]+Math.random()*0.06)),
    epsilon:0.45,
    // RL memory for post-collapse learning
    collapseMemory:{q:null,lastLoss:null,lastAction:null},
    lastAction:null,lastReward:0,
    // per-cycle
    tradeCount:0,allianceCount:0,conflictCount:0,conserveCount:0,expandCount:0,climateHits:0,
    // cumulative
    totalTrades:0,totalAlliances:0,totalConflicts:0,
    trust:{},
  };
}

function initState() {
  S = {
    cycle:0,running:false,speed:0,timer:null,selectedId:null,
    totalTrades:0,totalConflicts:0,totalAlliances:0,totalCollapses:0,totalRegrowths:0,
    climateEvents:[],emergentBehaviors:[],econHistory:[],
    recentTrades:[],alliances:[],
    regions: REALM_DEFS.map(mkRegion),
  };
  S.regions.forEach(r=>S.regions.forEach(o=>{if(r.id!==o.id)r.trust[o.id]=Math.random()*0.4-0.1;}));
}
initState();

// ‚îÄ‚îÄ RL ‚îÄ‚îÄ
function rsOf(r){
  const avg=(r.res.water+r.res.food+r.res.energy+r.res.land)/4;
  return avg<20?0:avg<40?1:avg<65?2:3;
}
function pickAction(r){
  if(!r.alive) return null;
  // Post-collapse: bias heavily toward conserve+trade, away from raid
  if(r.phase==='regrowth'){
    if(Math.random()<0.5) return 0; // conserve
    if(Math.random()<0.5) return 1; // trade
  }
  if(Math.random()<r.epsilon) return Math.floor(Math.random()*5);
  const qs=r.q[rsOf(r)]; return qs.indexOf(Math.max(...qs));
}
function updQ(r,s,a,reward,ns){
  const alpha=0.18, gamma=0.88;
  const best=Math.max(...r.q[ns]);
  r.q[s][a]+=alpha*(reward+gamma*best-r.q[s][a]);
  r.epsilon=Math.max(0.04,r.epsilon*0.9985);
}
function bestRes(r){return Object.entries(r.res).sort((a,b)=>b[1]-a[1])[0][0];}
function worstRes(r){return Object.entries(r.res).sort((a,b)=>a[1]-b[1])[0][0];}
function C(v,lo,hi){return Math.min(hi,Math.max(lo,v));}

function execAction(r,action){
  let reward=0; const logs=[];
  const alive=S.regions.filter(x=>x.alive&&x.id!==r.id);

  if(action===0){// CONSERVE
    r.res.water =C(r.res.water +3+Math.random()*3,0,100);
    r.res.food  =C(r.res.food  +3+Math.random()*4,0,100);
    r.res.energy=C(r.res.energy+2+Math.random()*3,0,100);
    reward=4+Math.random()*2; r.conserveCount++;
    logs.push({t:'lg',m:`${r.short} conserves resources ‚Äî reserves stabilized`});

  } else if(action===1){// TRADE
    const par=alive.sort((a,b)=>(r.trust[b.id]||0)-(r.trust[a.id]||0))[0];
    if(par){
      const give=bestRes(r), get=worstRes(r);
      const amt=10+Math.floor(Math.random()*12);
      if(r.res[give]>28){
        r.res[give] =C(r.res[give] -amt*0.65,0,100);
        par.res[give]=C(par.res[give]+amt*0.50,0,100);
        r.res[get]  =C(r.res[get]  +amt*0.55,0,100);
        par.res[get] =C(par.res[get] -amt*0.30,0,100);
        r.trust[par.id] =C((r.trust[par.id]||0)+0.07,-1,1);
        par.trust[r.id] =C((par.trust[r.id]||0)+0.07,-1,1);
        r.tradeCount++;r.totalTrades++;S.totalTrades++;
        reward=7+Math.random()*3;
        S.recentTrades.unshift({from:r.short,to:par.short,res:give,amt:Math.round(amt),cycle:S.cycle});
        if(S.recentTrades.length>10) S.recentTrades.pop();
        logs.push({t:'lt',m:`${r.name} ‚Üî ${par.name}: ${give}√ó${Math.round(amt)} traded`});
      }else reward=1;
    }

  } else if(action===2){// EXPAND
    const cost={food:4,water:3,energy:3,land:2};
    const can=Object.entries(cost).every(([k,v])=>r.res[k]>=v+12);
    if(can){
      Object.entries(cost).forEach(([k,v])=>{r.res[k]=C(r.res[k]-v,0,100);});
      r.res.land=C(r.res.land+5,0,100);
      r.population=Math.min(200,r.population+4);
      reward=5; r.expandCount++;
      logs.push({t:'lg',m:`${r.name} expands (+pop +land)`});
    }else reward=-1;

  } else if(action===3){// RAID
    const targets=alive.filter(o=>o.res.food>25||o.res.energy>25);
    if(targets.length){
      const t=targets.sort((a,b)=>(a.res.food+a.res.water+a.res.energy)-(b.res.food+b.res.water+b.res.energy))[0];
      S.totalConflicts++;r.conflictCount++;r.totalConflicts++;t.conflictCount++;
      r.trust[t.id]=C((r.trust[t.id]||0)-0.2,-1,1);
      t.trust[r.id]=C((t.trust[r.id]||0)-0.35,-1,1);
      const alIdx=S.alliances.findIndex(a=>(a.a===r.id&&a.b===t.id)||(a.a===t.id&&a.b===r.id));
      if(alIdx>=0){S.alliances.splice(alIdx,1);r.econPts-=12;t.econPts-=12;logs.push({t:'lc',m:`‚öî Alliance ${r.short}‚Üî${t.short} SHATTERED`});}
      if(Math.random()<0.5){
        const loot=10+Math.floor(Math.random()*12); const res=worstRes(r);
        t.res[res]=C(t.res[res]-loot*0.65,0,100);
        r.res[res]=C(r.res[res]+loot*0.6,0,100);
        reward=5;
        logs.push({t:'lc',m:`‚öî ${r.short} raids ${t.short} ‚Äî seized ${loot} ${res}`});
      }else{
        r.res.energy=C(r.res.energy-8,0,100);r.res.food=C(r.res.food-5,0,100);
        reward=-4;
        logs.push({t:'lc',m:`‚öî ${r.short} REPELLED by ${t.short}`});
      }
    }

  } else if(action===4){// ALLY
    const cands=alive.filter(o=>{
      const t=r.trust[o.id]||0;
      return t>0.22&&!S.alliances.some(a=>(a.a===r.id&&a.b===o.id)||(a.a===o.id&&a.b===r.id));
    });
    if(cands.length){
      const p=cands.sort((a,b)=>(r.trust[b.id]||0)-(r.trust[a.id]||0))[0];
      S.alliances.push({a:r.id,b:p.id,formed:S.cycle});
      r.allianceCount++;r.totalAlliances++;p.allianceCount++;S.totalAlliances++;
      r.trust[p.id]=C((r.trust[p.id]||0)+0.15,-1,1);
      p.trust[r.id]=C((p.trust[r.id]||0)+0.15,-1,1);
      reward=10;
      logs.push({t:'la',m:`üõ° ALLIANCE: ${r.name} ‚Üî ${p.name}`});
    }else reward=0;
  }
  return{reward,logs};
}

function naturalDepletion(r){
  const pf=r.phase==='regrowth'?0.5:r.phase==='struggling'?0.8:r.population/100;
  r.prevRes={...r.res};
  r.res.water =C(r.res.water -(1.1+Math.random()*0.9)*pf,0,100);
  r.res.food  =C(r.res.food  -(1.4+Math.random()*1.4)*pf,0,100);
  r.res.energy=C(r.res.energy-(0.8+Math.random()*0.9)*pf,0,100);
  r.res.land  =C(r.res.land  -0.2*Math.random(),0,100);
}

function computePhase(r){
  if(!r.alive) return 'collapsed';
  const avg=(r.res.water+r.res.food+r.res.energy+r.res.land)/4;
  if(r.phase==='regrowth' && S.cycle-r.regrowthCycle < 20) return 'regrowth';
  if(avg>65) return 'thriving';
  if(avg>45) return 'stable';
  if(avg>28) return 'struggling';
  return 'critical';
}

// ‚îÄ‚îÄ COLLAPSE & REGROWTH ‚îÄ‚îÄ
function checkAndHandleCollapse(){
  S.regions.forEach(r=>{
    if(!r.alive) return;
    const avg=(r.res.water+r.res.food+r.res.energy+r.res.land)/4;
    if(avg < 8){
      // COLLAPSE
      r.alive=false;
      r.phase='collapsed';
      r.collapseCount++;
      r.collapseCycle=S.cycle;
      S.totalCollapses++;
      r.econPts=Math.max(0,r.econPts-40);
      // Save collapse memory for learning
      r.collapseMemory={
        q: r.q.map(row=>[...row]),
        lastAction: r.lastAction,
        worstRes: worstRes(r),
        avgRes: avg,
        cause: identifyCollapseCause(r),
      };
      // PUNISH the action that led here
      if(r.lastAction!==null){
        const s=rsOf(r);
        r.q[0][r.lastAction]-=0.3; // heavy penalty in critical state
        r.q[1][r.lastAction]-=0.2;
      }
      // BOOST conserve+trade in critical states
      r.q[0][0]+=0.4; // conserve in critical
      r.q[0][1]+=0.3; // trade in critical
      r.q[1][0]+=0.2;
      r.q[1][1]+=0.2;
      S.alliances=S.alliances.filter(a=>a.a!==r.id&&a.b!==r.id);
      addLog('lc',`üíÄ ${r.name.toUpperCase()} COLLAPSED ‚Äî ${r.collapseMemory.cause}`);
      addBeh(`${r.short} collapsed (${r.collapseMemory.cause}) ‚Äî Q-table punished, learning initiated`);
      // Schedule regrowth after 15 cycles
      r._regrowthScheduled=S.cycle+15;
    }
  });
}

function identifyCollapseCause(r){
  const res=['water','food','energy','land'];
  const low=res.filter(k=>r.res[k]<15);
  if(low.length>0) return low.join('+')+' depletion';
  const bestA=ACTS[r.q[2].indexOf(Math.max(...r.q[2]))];
  return `over-reliance on ${bestA}`;
}

function handleRegrowth(){
  S.regions.forEach(r=>{
    if(r.alive) return;
    if(!r._regrowthScheduled || S.cycle < r._regrowthScheduled) return;
    // REGROW
    r.alive=true;
    r.phase='regrowth';
    r.regrowthCount++;
    r.regrowthCycle=S.cycle;
    S.totalRegrowths++;
    r._regrowthScheduled=null;
    // Restore to minimal viable resources
    r.res.water =20+Math.random()*15;
    r.res.food  =18+Math.random()*15;
    r.res.energy=18+Math.random()*15;
    r.res.land  =20+Math.random()*15;
    r.population=Math.max(30,r.population-20);
    // Regrowth bonus
    r.econPts+=20;
    // Boost epsilon to re-explore with new knowledge
    r.epsilon=Math.min(0.35, r.epsilon+0.2);
    addLog('lr',`üå± ${r.name.toUpperCase()} REGROWS ‚Äî ${r.collapseCount}x collapse, learning applied`);
    addBeh(`${r.short} achieved regrowth after collapse ‚Äî applying learned penalties`);
  });
}

function doClimate(){
  if(Math.random()>0.16) return;
  const evts=[
    {n:'DROUGHT',    res:'water', mod:-18,bad:true},
    {n:'FAMINE',     res:'food',  mod:-20,bad:true},
    {n:'SOLAR FLARE',res:'energy',mod:-16,bad:true},
    {n:'FLOOD',      res:'land',  mod:-12,bad:true},
    {n:'RAINFALL',   res:'water', mod:+22,bad:false},
    {n:'HARVEST',    res:'food',  mod:+20,bad:false},
    {n:'GEO SURGE',  res:'energy',mod:+18,bad:false},
  ];
  const e=evts[Math.floor(Math.random()*evts.length)];
  const aff=S.regions.filter(r=>r.alive).sort(()=>Math.random()-0.5).slice(0,1+Math.floor(Math.random()*2));
  aff.forEach(r=>{r.res[e.res]=C(r.res[e.res]+e.mod,0,100);if(e.bad)r.climateHits++;});
  const names=aff.map(r=>r.short).join(', ');
  S.climateEvents.unshift(`[${pad(S.cycle)}] ${e.n} ‚Üí ${names}`);
  if(S.climateEvents.length>15) S.climateEvents.pop();
  addLog('lm',`üå° ${e.n} hits ${names}`);
  const cb=document.getElementById('climate-badge');
  cb.textContent=`${e.bad?'üå©':'‚òÄ'} ${e.n}`;
  cb.style.color=e.bad?'var(--warn)':'var(--ok)';
  setTimeout(()=>{cb.textContent='‚òÄ CLIMATE: STABLE';cb.style.color='var(--ok)';},2500);
}

function detectEmergent(){
  if(S.cycle%20!==0) return;
  S.regions.forEach(r=>{
    if(!r.alive) return;
    const best=r.q[2].indexOf(Math.max(...r.q[2]));
    if(best===1&&r.totalTrades>8) addBeh(`${r.short} emerged as TRADE hub (${r.totalTrades} trades)`);
    if(best===0&&r.res.water<35) addBeh(`${r.short} learned CONSERVATION after water crisis`);
    if(best===3&&r.res.food>65&&r.collapseCount===0) addBeh(`${r.short} uses AGGRESSION to guard surplus`);
    if(best===4&&r.totalAlliances>2) addBeh(`${r.short} mastered ALLIANCE diplomacy`);
    if(r.collapseCount>0&&r.regrowthCount>0&&r.phase!=='collapsed') addBeh(`${r.short} rebuilt (${r.collapseCount} collapse, ${r.regrowthCount} regrowth) ‚Äî resilient strategy`);
  });
  S.regions.forEach(r=>S.regions.forEach(o=>{
    if(r.id<o.id&&(r.trust[o.id]||0)>0.55) addBeh(`${r.short}‚Üî${o.short} deep trust (${((r.trust[o.id]||0)*100).toFixed(0)}%)`);
  }));
}

function addBeh(b){
  if(!S.emergentBehaviors.includes(b)){
    S.emergentBehaviors.push(b);
    if(S.emergentBehaviors.length>12) S.emergentBehaviors.shift();
  }
}

// ‚îÄ‚îÄ SIM STEP ‚îÄ‚îÄ
function simStep(){
  S.cycle++;
  S.regions.forEach(r=>{r.tradeCount=0;r.allianceCount=0;r.conflictCount=0;r.conserveCount=0;r.expandCount=0;r.climateHits=0;});
  doClimate();
  handleRegrowth();

  S.regions.forEach(r=>{
    if(!r.alive) return;
    naturalDepletion(r);
    const s=rsOf(r);
    const action=pickAction(r);
    if(action===null) return;
    const{reward,logs}=execAction(r,action);
    const ns=rsOf(r);
    updQ(r,s,action,reward,ns);
    r.lastAction=action; r.lastReward=reward; r.age++;
    logs.forEach(l=>addLog(l.t,l.m));
    r.phase=computePhase(r);
  });

  checkAndHandleCollapse();
  detectEmergent();

  // Economy pts
  let maxPts=-Infinity, leader=null;
  S.regions.forEach(r=>{
    const delta=computeDelta(r);
    r.econDelta=delta;
    r.econPts=Math.max(r.alive?10:0, r.econPts+delta);
    if(r.alive&&r.econPts>maxPts){maxPts=r.econPts;leader=r;}
  });

  S.econHistory.push({cycle:S.cycle,pts:S.regions.map(r=>r.econPts)});
  if(S.econHistory.length>300) S.econHistory.shift();  // keep last 300 for graph
  if(leader) document.getElementById('t-leader').textContent=leader.short;

  updateUI();
  drawWorld();
  drawGraph();
}

function computeDelta(r){
  if(!r.alive) return -2; // slow drain while collapsed
  let pts=0; FACTORS.forEach(f=>{pts+=f.pts(f.compute(r));});
  return pts;
}

// ‚îÄ‚îÄ UI ‚îÄ‚îÄ
function updateUI(){
  document.getElementById('t-cycle').textContent=S.cycle;
  document.getElementById('t-active').textContent=S.regions.filter(r=>r.alive).length;
  document.getElementById('t-coll').textContent=S.regions.filter(r=>!r.alive).length;
  document.getElementById('t-regrow').textContent=S.totalRegrowths;
  document.getElementById('t-trades').textContent=S.totalTrades;
  document.getElementById('t-alliances').textContent=S.alliances.length;
  document.getElementById('map-cycle-lbl').textContent=`CYC ${S.cycle}`;

  buildOvCards();
  buildResGrid();
  buildRanking();
  buildMibPanels();
  buildAnalysis();
}

// ‚îÄ‚îÄ OVERVIEW CARDS ‚îÄ‚îÄ
function phaseLabel(r){
  if(r.phase==='collapsed') return {txt:'COLLAPSED',col:'var(--danger)'};
  if(r.phase==='regrowth')  return {txt:'REGROWING üå±',col:'#a0e870'};
  if(r.phase==='critical')  return {txt:'CRITICAL ‚ö†',col:'var(--warn)'};
  if(r.phase==='struggling')return {txt:'STRUGGLING',col:'var(--warn)'};
  if(r.phase==='thriving')  return {txt:'THRIVING ‚ú¶',col:'var(--gold2)'};
  return {txt:'STABLE',col:'var(--text2)'};
}

function resColor(k,v){
  if(v<15) return '#e84848';
  if(v<30) return '#f09030';
  return {water:'#38b4f0',food:'#5ed468',energy:'#f5c830',land:'#c8784a'}[k];
}

function buildOvCards(){
  const sorted=[...S.regions].sort((a,b)=>b.econPts-a.econPts);
  const wrap=document.getElementById('ov-cards');
  wrap.innerHTML='';
  sorted.forEach((r,rank)=>{
    const pl=phaseLabel(r);
    const bestA=r.alive?ACTS[r.q[2].indexOf(Math.max(...r.q[2]))]:'‚Äî';
    const card=document.createElement('div');
    const cardClass='realm-card'
      +(S.selectedId===r.id?' sel':'')
      +(r.phase==='collapsed'?' collapsed':'')
      +(r.phase==='regrowth'?' regrow':'')
      +(['struggling','critical'].includes(r.phase)?' struggle':'');
    card.className=cardClass;
    card.style.setProperty('--rc',r.color);

    // Resource trend arrows
    const trend=k=>{
      if(!r.prevRes) return '';
      const d=r.res[k]-r.prevRes[k];
      return d>0.3?'<span style="color:var(--ok)">‚ñ≤</span>':d<-0.3?'<span style="color:var(--danger)">‚ñº</span>':'<span style="color:var(--dim)">‚Äî</span>';
    };

    card.innerHTML=`
      <div class="rc-header">
        <div class="rc-name-wrap">
          <div class="rc-name" style="color:${r.color}">${r.name}</div>
          <div class="rc-phase" style="background:${hexA(pl.col,0.12)};color:${pl.col};border:1px solid ${hexA(pl.col,0.3)}">${pl.txt}</div>
        </div>
        <div class="rc-right">
          <div class="rc-strat" style="background:${hexA(r.color,0.12)};color:${r.color};border:1px solid ${hexA(r.color,0.25)}">${bestA}</div>
          <div class="rc-econ">${Math.round(r.econPts)}</div>
          <div class="rc-delta" style="color:${r.econDelta>=0?'var(--ok)':'var(--danger)'}">${r.econDelta>=0?'‚ñ≤':'‚ñº'}${Math.abs(Math.round(r.econDelta))} pts/cycle</div>
        </div>
      </div>
      <div class="res-bars">
        ${['water','food','energy','land'].map(k=>`
          <div class="res-bar-row">
            <span class="res-icon">${{water:'üíß',food:'üåæ',energy:'‚ö°',land:'üó∫'}[k]}</span>
            <span class="res-label">${k.toUpperCase()}</span>
            <div class="res-track">
              <div class="res-fill" style="width:${r.res[k]}%;background:linear-gradient(90deg,${hexA(resColor(k,r.res[k]),0.8)},${resColor(k,r.res[k])})">
              </div>
              <div class="res-segments">${Array(5).fill(0).map((_,i)=>`<div class="res-seg"></div>`).join('')}</div>
            </div>
            <span class="res-val" style="color:${resColor(k,r.res[k])}">${Math.round(r.res[k])}</span>
            <span class="res-trend">${trend(k)}</span>
          </div>`).join('')}
      </div>
      <div class="rc-footer">
        <div class="rc-stat">üë• <span>${r.population}</span></div>
        <div class="rc-stat">ü§ù <span>${r.totalTrades}</span></div>
        <div class="rc-stat">üíÄ <span>${r.collapseCount}√ó</span></div>
        <div class="rc-stat">üå± <span>${r.regrowthCount}√ó</span></div>
        <div style="margin-left:auto;font-family:var(--font-ui);font-size:12px;color:${r.color}">RANK #${rank+1}</div>
      </div>
      ${r.phase==='regrowth'?`<div style="font-size:11px;color:#a0e870;font-family:var(--font-body);margin-top:8px;padding:6px 8px;background:rgba(160,232,112,0.06);border-radius:4px;border:1px solid rgba(160,232,112,0.2)">üå± Rebuilding from collapse ‚Äî learned penalties applied, exploring new strategies</div>`:''}
      ${!r.alive&&r._regrowthScheduled?`<div style="font-size:11px;color:var(--warn);font-family:var(--font-body);margin-top:8px;padding:6px 8px;background:rgba(240,144,48,0.06);border-radius:4px;border:1px solid rgba(240,144,48,0.2)">‚è≥ Regrowth scheduled at cycle ${r._regrowthScheduled} ‚Äî Q-values updated</div>`:''}
    `;
    card.onclick=()=>{S.selectedId=r.id;buildOvCards();buildMibPanels();drawWorld();};
    wrap.appendChild(card);
  });
}

// ‚îÄ‚îÄ RESOURCE GRID ‚îÄ‚îÄ
function buildResGrid(){
  const wrap=document.getElementById('rg-inner');
  wrap.innerHTML='';
  S.regions.forEach(r=>{
    const pl=phaseLabel(r);
    const div=document.createElement('div');
    div.className='rg-realm';
    div.innerHTML=`
      <div class="rg-header" style="border-bottom:1px solid ${hexA(r.color,0.25)}">
        <div>
          <div class="rg-hname" style="color:${r.color}">${r.name}</div>
          <div style="font-family:var(--font-mono);font-size:9px;color:${pl.col};margin-top:2px">${pl.txt}</div>
        </div>
        <div style="text-align:right">
          <div class="rg-hecon">${Math.round(r.econPts)}</div>
          <div style="font-family:var(--font-body);font-size:11px;color:${r.econDelta>=0?'var(--ok)':'var(--danger)'}">${r.econDelta>=0?'+':''}${Math.round(r.econDelta)}/cycle</div>
        </div>
      </div>
      <div class="rg-body">
        <div class="rg-res-grid">
          ${['water','food','energy','land'].map(k=>{
            const v=r.res[k]; const c=resColor(k,v);
            return `<div class="rg-res-box" style="border-color:${hexA(c,0.2)}">
              <div class="rg-res-top">
                <span class="rg-res-icon">${{water:'üíß',food:'üåæ',energy:'‚ö°',land:'üó∫'}[k]}</span>
                <span class="rg-res-name">${k.toUpperCase()}</span>
              </div>
              <div class="rg-res-val" style="color:${c}">${Math.round(v)}</div>
              <div class="rg-res-bar"><div class="rg-res-fill" style="width:${v}%;background:${c}"></div></div>
            </div>`;
          }).join('')}
        </div>
        <div class="rg-factors">
          ${FACTORS.map(f=>{
            const val=f.compute(r),pts=f.pts(val);
            return `<div class="rg-factor">
              <span class="rg-f-name">${f.icon} ${f.name.split(' ')[0]}</span>
              <span class="rg-f-val ${pts>0?'pos':pts<0?'neg':'neu'}">${pts>0?'+':''}${pts}</span>
            </div>`;
          }).join('')}
        </div>
      </div>
    `;
    wrap.appendChild(div);
  });
}

// ‚îÄ‚îÄ RANKING ‚îÄ‚îÄ
function buildRanking(){
  const sorted=[...S.regions].sort((a,b)=>b.econPts-a.econPts);
  const maxPts=Math.max(...sorted.map(r=>r.econPts),1);
  const body=document.getElementById('rank-body');
  body.innerHTML='';
  sorted.forEach((r,i)=>{
    const rank=i+1;
    const rcls=rank===1?'r1':rank===2?'r2':rank===3?'r3':'rn';
    const bw=Math.max(4,(r.econPts/maxPts)*100).toFixed(1);
    const allies=S.alliances.filter(a=>a.a===r.id||a.b===r.id)
      .map(a=>S.regions.find(x=>x.id===(a.a===r.id?a.b:a.a)).short).join(',') || '‚Äî';
    const pl=phaseLabel(r);
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><div class="rnum ${rcls}">${rank}</div></td>
      <td><div class="rbadge"><div class="rdot" style="background:${r.color}"></div><span class="rname" style="color:${r.color}">${r.name}</span></div></td>
      <td><span class="rpts" style="color:${r.color}">${Math.round(r.econPts)}</span></td>
      <td><div class="rbar-wrap"><div class="rbar-bg"><div class="rbar-fg" style="width:${bw}%;background:linear-gradient(90deg,${hexA(r.color,0.7)},${r.color})"><span class="rbar-label">${Math.round(r.econPts)}</span></div></div></div></td>
      <td><span class="rdelta" style="color:${r.econDelta>=0?'var(--ok)':'var(--danger)'}">${r.econDelta>=0?'‚ñ≤':'‚ñº'}${Math.abs(Math.round(r.econDelta))}</span></td>
      <td style="color:${resColor('water',r.res.water)};font-family:var(--font-ui);font-size:12px">${Math.round(r.res.water)}</td>
      <td style="color:${resColor('food',r.res.food)};font-family:var(--font-ui);font-size:12px">${Math.round(r.res.food)}</td>
      <td style="color:${resColor('energy',r.res.energy)};font-family:var(--font-ui);font-size:12px">${Math.round(r.res.energy)}</td>
      <td style="color:${resColor('land',r.res.land)};font-family:var(--font-ui);font-size:12px">${Math.round(r.res.land)}</td>
      <td style="color:var(--food);font-family:var(--font-ui);font-size:12px">${r.totalTrades}</td>
      <td style="color:var(--valyria);font-size:11px;font-family:var(--font-body)">${allies}</td>
      <td><span class="rstatus" style="color:${pl.col}">${pl.txt}</span></td>
    `;
    body.appendChild(tr);
  });
  // RP legend once
  const leg=document.getElementById('rp-legend');
  if(leg.children.length===0){
    RP_LEGEND.forEach(item=>{
      const row=document.createElement('div');
      row.className='rp-row';
      row.innerHTML=`<span class="rp-icon">${item.icon}</span><span class="rp-name">${item.name}</span>
        <span class="rp-pts" style="color:${item.pos?'var(--ok)':'var(--danger)'}">${item.pts}</span>`;
      leg.appendChild(row);
    });
  }
}

// ‚îÄ‚îÄ MIB PANELS ‚îÄ‚îÄ
function buildMibPanels(){
  // Alliances
  const ap=document.getElementById('mib-alliances');
  if(S.alliances.length===0){ap.innerHTML='<span style="color:var(--dim)">No alliances yet</span>';}
  else ap.innerHTML=S.alliances.map(al=>{
    const r1=S.regions.find(x=>x.id===al.a),r2=S.regions.find(x=>x.id===al.b);
    const t=((r1.trust[r2.id]||0)*100).toFixed(0);
    return `<div class="al-chip">
      <span style="width:8px;height:8px;border-radius:50%;background:${r1.color};display:inline-block"></span>
      <span style="color:${r1.color}">${r1.short}</span>‚öî
      <span style="width:8px;height:8px;border-radius:50%;background:${r2.color};display:inline-block"></span>
      <span style="color:${r2.color}">${r2.short}</span>
      <span style="color:var(--dim)">${t}%</span>
    </div>`;
  }).join('');

  // Q-table
  const qp=document.getElementById('mib-qtable');
  if(S.selectedId===null){qp.innerHTML='<span style="color:var(--dim)">Click realm on map</span>';return;}
  const r=S.regions.find(x=>x.id===S.selectedId);
  const sts=['CRIT','LOW','MED','HIGH'];
  let h=`<div style="font-family:var(--font-ui);font-size:11px;color:${r.color};margin-bottom:5px;font-weight:700">${r.name} ${r.phase==='collapsed'?'(COLLAPSED)':''}</div>`;
  h+=`<div style="display:grid;grid-template-columns:34px repeat(5,1fr);gap:2px;font-size:9px;font-family:var(--font-mono)">`;
  h+=`<div></div>${ACTS.map(a=>`<div style="color:var(--dim);text-align:center">${a.slice(0,3)}</div>`).join('')}`;
  r.q.forEach((row,si)=>{
    const mv=Math.max(...row);
    h+=`<div style="color:var(--dim);font-size:9px;align-self:center">${sts[si]}</div>`;
    row.forEach((v,ai)=>{
      const isBest=Math.abs(v-mv)<0.001;
      h+=`<div style="background:${isBest?hexA(r.color,0.25):'rgba(255,255,255,0.02)'};border:1px solid ${isBest?r.color:'transparent'};border-radius:2px;padding:2px;text-align:center;color:${isBest?r.color:'var(--dim)'};font-size:9px">${v.toFixed(2)}</div>`;
    });
  });
  h+=`</div>`;
  h+=`<div style="font-size:10px;color:var(--dim);margin-top:5px;font-family:var(--font-body)">Strategy: <span style="color:${r.color}">${r.alive?ACTS[r.q[2].indexOf(Math.max(...r.q[2]))]:'REBUILDING'}</span> ¬∑ Œµ:${(r.epsilon*100).toFixed(0)}% ¬∑ collapses:${r.collapseCount}</div>`;
  qp.innerHTML=h;

  // Behaviors
  const bp=document.getElementById('mib-behaviors');
  bp.innerHTML=S.emergentBehaviors.length>0
    ?S.emergentBehaviors.slice(-6).map(b=>`<div style="color:var(--gold);margin-bottom:3px">‚ñ∏ ${b}</div>`).join('')
    :'<span style="color:var(--dim)">Observing...</span>';
}

// ‚îÄ‚îÄ ANALYSIS ‚îÄ‚îÄ
function buildAnalysis(){
  if(S.cycle<10) return;
  const sorted=[...S.regions].sort((a,b)=>b.econPts-a.econPts);
  const leader=sorted[0];
  const collapsed=S.regions.filter(r=>!r.alive);
  const regrown=S.regions.filter(r=>r.regrowthCount>0);
  const wrap=document.getElementById('ana-inner');
  let h='';

  h+=`<div class="ins-card"><div class="ins-hd">üèÜ DOMINANT REALM</div><div class="ins-bd">
    <em>${leader.name}</em> leads with <em>${Math.round(leader.econPts)} pts</em>. 
    Dominant strategy: <em>${ACTS[leader.q[2].indexOf(Math.max(...leader.q[2]))]}</em>. 
    ${leader.totalTrades>5?`${leader.totalTrades} trade deals executed. `:''}
    ${S.alliances.some(a=>a.a===leader.id||a.b===leader.id)?'Alliance bonuses active. ':''}
    Resources: üíß${Math.round(leader.res.water)} üåæ${Math.round(leader.res.food)} ‚ö°${Math.round(leader.res.energy)} üó∫${Math.round(leader.res.land)}
  </div></div>`;

  if(collapsed.length>0){
    h+=`<div class="ins-card" style="border-color:rgba(232,72,72,0.25)"><div class="ins-hd" style="color:var(--danger)">üíÄ COLLAPSED REALMS</div><div class="ins-bd">
      ${collapsed.map(r=>`<em>${r.name}</em>: collapsed ${r.collapseCount}√ó ‚Äî <span class="highlight">${r.collapseMemory?.cause||'resource depletion'}</span>. 
        Q-table punished action <em>${r.lastAction!==null?ACTS[r.lastAction]:'unknown'}</em>. 
        Regrowth ${r._regrowthScheduled?'at cycle '+r._regrowthScheduled:'pending'}.`).join('<br><br>')}
    </div></div>`;
  }

  if(regrown.length>0){
    h+=`<div class="ins-card" style="border-color:rgba(160,232,112,0.25)"><div class="ins-hd" style="color:#a0e870">üå± REGROWTH LEARNING</div><div class="ins-bd">
      ${regrown.map(r=>`<em>${r.name}</em> has regrown ${r.regrowthCount}√ó after ${r.collapseCount} collapse(s). 
        Now favors <em>${ACTS[r.q[2].indexOf(Math.max(...r.q[2]))]}</em> over prior failed strategies. 
        Economy: <em>${Math.round(r.econPts)} pts</em>.`).join('<br><br>')}
      <br><br><em>RL Insight:</em> Post-collapse Q-value updates redirect agents away from depleting strategies. 
      Regrown realms show higher CONSERVE/TRADE Q-values ‚Äî validating that collapse serves as a hard negative reinforcement signal.
    </div></div>`;
  }

  const sd={};
  S.regions.forEach(r=>{if(r.alive){const a=ACTS[r.q[2].indexOf(Math.max(...r.q[2]))];sd[a]=(sd[a]||0)+1;}});
  h+=`<div class="ins-card"><div class="ins-hd">üìä STRATEGY DISTRIBUTION</div><div class="ins-bd">
    ${Object.entries(sd).map(([a,n])=>`<em>${a}</em>: ${n} realm(s). `).join('')}
    <br><br>Aggressive RAID strategies show high early rewards but collapse-prone behavior ‚Äî 
    realms that raided most collapsed first. Post-collapse Q-tables suppress raid in critical states.
    <br><em>Real-world parallel:</em> Extractive resource policies yield short-term gains but destroy long-term stability.
  </div></div>`;

  h+=`<div class="ins-card"><div class="ins-hd">üß† RL CONVERGENCE</div><div class="ins-bd">
    Avg exploration Œµ: <em>${(S.regions.reduce((s,r)=>s+r.epsilon,0)/5*100).toFixed(1)}%</em>.<br>
    Total collapses: <em>${S.totalCollapses}</em> ¬∑ Total regrowths: <em>${S.totalRegrowths}</em><br>
    Each collapse injects a ‚àí0.3 Q-penalty for the triggering action in critical states and a +0.4 boost for CONSERVE ‚Äî
    forcing agents to <em>learn resilience through failure</em> rather than pre-programmed rules.
  </div></div>`;

  wrap.innerHTML=h;
}

// ‚îÄ‚îÄ WORLD MAP ‚îÄ‚îÄ
const wc=document.getElementById('worldCanvas');
const wctx=wc.getContext('2d');

function resizeCanvas(){
  wc.width=wc.parentElement.clientWidth;
  // subtract topbar, infobar, evlog heights from parent
  const parent=wc.parentElement;
  const usedH=parent.querySelector('.map-topbar').offsetHeight
    +parent.querySelector('.map-infobar').offsetHeight
    +parent.querySelector('.evlog').offsetHeight;
  wc.height=parent.clientHeight-usedH;
  drawWorld();
  drawGraph();
}
window.addEventListener('resize',resizeCanvas);
setTimeout(resizeCanvas,120);

function drawWorld(){
  if(!wc.width||!wc.height) return;
  const W=wc.width,H=wc.height;
  wctx.clearRect(0,0,W,H);

  // BG
  const bg=wctx.createRadialGradient(W*.5,H*.45,0,W*.5,H*.45,Math.max(W,H)*.7);
  bg.addColorStop(0,'#0d1428'); bg.addColorStop(1,'#060810');
  wctx.fillStyle=bg; wctx.fillRect(0,0,W,H);

  // grid
  wctx.strokeStyle='rgba(24,38,58,0.55)'; wctx.lineWidth=1;
  for(let x=0;x<W;x+=55){wctx.beginPath();wctx.moveTo(x,0);wctx.lineTo(x,H);wctx.stroke();}
  for(let y=0;y<H;y+=55){wctx.beginPath();wctx.moveTo(0,y);wctx.lineTo(W,y);wctx.stroke();}

  // Alliance lines
  S.alliances.forEach(al=>{
    const r1=S.regions.find(x=>x.id===al.a),r2=S.regions.find(x=>x.id===al.b);
    const x1=r1.x*W,y1=r1.y*H,x2=r2.x*W,y2=r2.y*H;
    wctx.strokeStyle='rgba(200,168,76,0.28)';wctx.lineWidth=2.5;wctx.setLineDash([8,5]);
    wctx.beginPath();wctx.moveTo(x1,y1);wctx.lineTo(x2,y2);wctx.stroke();wctx.setLineDash([]);
    const mx=(x1+x2)/2,my=(y1+y2)/2;
    wctx.fillStyle='rgba(200,168,76,0.5)';wctx.font='12px sans-serif';wctx.textAlign='center';wctx.fillText('‚öî',mx,my);
  });

  // Trade lines
  S.recentTrades.slice(0,5).forEach((t,i)=>{
    const r1=S.regions.find(r=>r.short===t.from),r2=S.regions.find(r=>r.short===t.to);
    if(!r1||!r2) return;
    const a=0.7-i*0.12;
    wctx.strokeStyle=`rgba(94,212,104,${a})`;wctx.lineWidth=1.8;wctx.setLineDash([5,4]);
    wctx.beginPath();wctx.moveTo(r1.x*W,r1.y*H);wctx.lineTo(r2.x*W,r2.y*H);wctx.stroke();wctx.setLineDash([]);
    const ang=Math.atan2((r2.y-r1.y)*H,(r2.x-r1.x)*W);
    const mx=(r1.x+r2.x)/2*W,my=(r1.y+r2.y)/2*H;
    wctx.fillStyle=`rgba(94,212,104,${a})`;
    wctx.beginPath();wctx.moveTo(mx+Math.cos(ang)*9,my+Math.sin(ang)*9);
    wctx.lineTo(mx+Math.cos(ang+2.3)*5,my+Math.sin(ang+2.3)*5);
    wctx.lineTo(mx+Math.cos(ang-2.3)*5,my+Math.sin(ang-2.3)*5);wctx.fill();
  });

  // Conflict lines
  S.regions.forEach(r=>S.regions.forEach(o=>{
    if(r.id>=o.id) return;
    if((r.trust[o.id]||0)<-0.3){
      wctx.strokeStyle=`rgba(232,72,72,${Math.min(0.4,Math.abs(r.trust[o.id]||0)*0.45)})`;
      wctx.lineWidth=1;wctx.setLineDash([2,6]);
      wctx.beginPath();wctx.moveTo(r.x*W,r.y*H);wctx.lineTo(o.x*W,o.y*H);wctx.stroke();wctx.setLineDash([]);
    }
  }));

  // Realms
  S.regions.forEach(r=>{
    const x=r.x*W,y=r.y*H;
    const avg=(r.res.water+r.res.food+r.res.energy+r.res.land)/4;
    const health=avg/100;
    const bR=28+(r.population/200)*18;

    if(!r.alive){
      // COLLAPSED
      wctx.strokeStyle='rgba(232,72,72,0.25)';wctx.lineWidth=1;
      wctx.fillStyle='rgba(232,72,72,0.04)';
      wctx.beginPath();wctx.arc(x,y,bR,0,Math.PI*2);wctx.fill();wctx.stroke();
      // pulsing rebuild ring if scheduled
      if(r._regrowthScheduled){
        const prog=1-(r._regrowthScheduled-S.cycle)/15;
        wctx.strokeStyle=`rgba(160,232,112,${0.2+prog*0.3})`;wctx.lineWidth=2;wctx.setLineDash([4,4]);
        wctx.beginPath();wctx.arc(x,y,bR+8+prog*6,0,Math.PI*2*prog);wctx.stroke();wctx.setLineDash([]);
      }
      wctx.fillStyle='rgba(232,72,72,0.5)';wctx.font='16px sans-serif';wctx.textAlign='center';wctx.fillText('üíÄ',x,y+6);
      wctx.font=`700 10px Cinzel,serif`;wctx.fillStyle='rgba(200,80,70,0.5)';wctx.fillText(r.short,x,y+bR+16);
      return;
    }

    // Regrowth glow
    if(r.phase==='regrowth'){
      const t=Date.now()/1000;
      wctx.strokeStyle=`rgba(160,232,112,${0.2+0.15*Math.sin(t*2)})`;wctx.lineWidth=3;
      wctx.beginPath();wctx.arc(x,y,bR+12,0,Math.PI*2);wctx.stroke();
    }

    // Glow halo
    const hC=r.phase==='critical'?'#e84848':r.phase==='struggling'?'#f09030':r.color;
    const gr=wctx.createRadialGradient(x,y,bR*.3,x,y,bR*2.5);
    gr.addColorStop(0,hexA(hC,0.16));gr.addColorStop(1,'transparent');
    wctx.fillStyle=gr;wctx.beginPath();wctx.arc(x,y,bR*2.5,0,Math.PI*2);wctx.fill();

    // Selected
    if(S.selectedId===r.id){
      wctx.strokeStyle='rgba(240,204,106,0.6)';wctx.lineWidth=2;wctx.setLineDash([5,3]);
      wctx.beginPath();wctx.arc(x,y,bR+10,0,Math.PI*2);wctx.stroke();wctx.setLineDash([]);
    }

    // Resource arcs
    [{k:'water',c:'#38b4f0'},{k:'food',c:'#5ed468'},{k:'energy',c:'#f5c830'},{k:'land',c:'#c8784a'}].forEach(({k,c},i)=>{
      const f=r.res[k]/100;
      const s0=(i*Math.PI/2)-Math.PI/2;
      wctx.strokeStyle=hexA(resColor(k,r.res[k]),0.4+f*0.5);wctx.lineWidth=6;
      wctx.beginPath();wctx.arc(x,y,bR+6,s0,s0+(Math.PI/2)*0.82*f);wctx.stroke();
    });

    // Body
    wctx.fillStyle=hexA(r.color,0.18);wctx.strokeStyle=r.color;wctx.lineWidth=2;
    wctx.beginPath();wctx.arc(x,y,bR,0,Math.PI*2);wctx.fill();wctx.stroke();

    // Icons
    const bestA=r.q[2].indexOf(Math.max(...r.q[2]));
    wctx.font='14px sans-serif';wctx.textAlign='center';wctx.fillText(AICO[bestA],x,y-4);
    wctx.fillStyle='rgba(240,204,106,0.9)';wctx.font=`bold 11px Share Tech Mono`;
    wctx.fillText(`${Math.round(r.econPts)}‚öô`,x,y+11);

    // Name
    wctx.font=`700 10px Cinzel,serif`;wctx.fillStyle='rgba(192,208,224,0.9)';wctx.fillText(r.short,x,y+bR+17);

    // Health bar
    const bx=x-20,by=y+bR+21;
    wctx.fillStyle='rgba(0,0,0,0.4)';wctx.fillRect(bx,by,40,5);
    wctx.fillStyle=health>0.55?'#5ed468':health>0.3?'#f09030':'#e84848';
    wctx.fillRect(bx,by,40*health,5);
    // Phase dot
    const pl=phaseLabel(r);
    wctx.fillStyle=pl.col;wctx.beginPath();wctx.arc(x+24,by+2.5,3,0,Math.PI*2);wctx.fill();
  });

  // Legend
  const lx=16,ly=H-72;
  wctx.fillStyle='rgba(6,8,16,0.7)';wctx.fillRect(lx-4,ly-4,160,72);wctx.strokeStyle='rgba(24,38,58,0.8)';wctx.lineWidth=1;wctx.strokeRect(lx-4,ly-4,160,72);
  const leg=[{c:'rgba(94,212,104,0.7)',l:'‚Äî TRADE',dash:false},{c:'rgba(200,168,76,0.5)',l:'‚Äî ALLIANCE',dash:true},{c:'rgba(232,72,72,0.5)',l:'-- CONFLICT',dash:true},{c:'rgba(160,232,112,0.6)',l:'‚óã REGROWTH',dash:false}];
  leg.forEach((l,i)=>{
    if(i===1||i===2) wctx.setLineDash([4,3]); else wctx.setLineDash([]);
    wctx.strokeStyle=l.c;wctx.lineWidth=2;
    wctx.beginPath();wctx.moveTo(lx,ly+i*17+7);wctx.lineTo(lx+28,ly+i*17+7);wctx.stroke();wctx.setLineDash([]);
    wctx.fillStyle='rgba(192,208,224,0.6)';wctx.font='10px Share Tech Mono';wctx.textAlign='left';
    wctx.fillText(l.l,lx+32,ly+i*17+11);
  });
}

wc.addEventListener('click',e=>{
  const rect=wc.getBoundingClientRect();
  const mx=e.clientX-rect.left,my=e.clientY-rect.top;
  let best=null,minD=Infinity;
  S.regions.forEach(r=>{const d=Math.hypot(mx-r.x*wc.width,my-r.y*wc.height);if(d<minD){minD=d;best=r;}});
  if(best&&minD<80){S.selectedId=best.id;buildOvCards();buildMibPanels();drawWorld();}
});

// ‚îÄ‚îÄ GRAPH ‚îÄ‚îÄ
let graphVisible = false;
function toggleGraph(){
  graphVisible = !graphVisible;
  const overlay = document.getElementById('graph-overlay');
  const btn = document.getElementById('btn-graph');
  overlay.style.display = graphVisible ? 'flex' : 'none';
  overlay.style.flexDirection = graphVisible ? 'column' : '';
  btn.textContent = graphVisible ? 'üó∫ SHOW MAP' : 'üìà SHOW GRAPH';
  btn.style.color = graphVisible ? 'var(--gold)' : '';
  btn.style.borderColor = graphVisible ? 'var(--gold)' : '';
  if(graphVisible) drawGraph();
}

function drawGraph(){
  if(!graphVisible) return;
  const gc = document.getElementById('graphCanvas');
  if(!gc) return;
  const parent = gc.parentElement;
  gc.width = parent.clientWidth;
  gc.height = parent.clientHeight;
  const ctx = gc.getContext('2d');
  const W = gc.width, H = gc.height;
  if(W <= 0 || H <= 0) return;

  ctx.clearRect(0,0,W,H);

  // Background
  ctx.fillStyle = 'rgba(8,11,20,0.9)';
  ctx.fillRect(0,0,W,H);

  const PAD = {top:20, right:20, bottom:40, left:60};
  const cW = W - PAD.left - PAD.right;
  const cH = H - PAD.top - PAD.bottom;

  if(S.econHistory.length < 2){
    ctx.fillStyle = 'rgba(48,68,88,0.8)';
    ctx.font = `14px var(--font-ui,'Cinzel',serif)`;
    ctx.textAlign = 'center';
    ctx.fillText('Run simulation to populate graph...', W/2, H/2);
    return;
  }

  // Compute value range
  const allVals = S.econHistory.flatMap(h=>h.pts);
  const minV = Math.max(0, Math.min(...allVals) - 20);
  const maxV = Math.max(...allVals) + 30;
  const range = maxV - minV || 1;

  // Grid lines + Y labels
  const gridCount = 5;
  for(let i=0; i<=gridCount; i++){
    const y = PAD.top + cH - (i/gridCount)*cH;
    const val = minV + (i/gridCount)*range;
    ctx.strokeStyle = 'rgba(24,38,58,0.8)';
    ctx.lineWidth = 1;
    ctx.setLineDash([4,4]);
    ctx.beginPath(); ctx.moveTo(PAD.left, y); ctx.lineTo(PAD.left+cW, y); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = 'rgba(48,68,88,0.9)';
    ctx.font = `10px 'Share Tech Mono',monospace`;
    ctx.textAlign = 'right';
    ctx.fillText(Math.round(val), PAD.left-6, y+4);
  }

  // X labels (cycle numbers)
  const xTickCount = Math.min(8, S.econHistory.length);
  for(let i=0; i<=xTickCount; i++){
    const idx = Math.round((i/xTickCount)*(S.econHistory.length-1));
    const x = PAD.left + (idx/(S.econHistory.length-1))*cW;
    const cyc = S.econHistory[idx]?.cycle ?? 0;
    ctx.fillStyle = 'rgba(48,68,88,0.9)';
    ctx.font = `10px 'Share Tech Mono',monospace`;
    ctx.textAlign = 'center';
    ctx.fillText(cyc, x, PAD.top+cH+18);
    ctx.strokeStyle = 'rgba(24,38,58,0.5)';
    ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(x, PAD.top+cH); ctx.lineTo(x, PAD.top+cH+5); ctx.stroke();
  }

  // Axis labels
  ctx.fillStyle = 'rgba(80,110,140,0.8)';
  ctx.font = `11px 'Cinzel',serif`;
  ctx.textAlign = 'center';
  ctx.fillText('CYCLE', PAD.left + cW/2, H-4);
  ctx.save();
  ctx.translate(14, PAD.top + cH/2);
  ctx.rotate(-Math.PI/2);
  ctx.fillText('ECONOMY PTS', 0, 0);
  ctx.restore();

  // Collapse & regrowth event markers
  S.regions.forEach(r=>{
    if(r.collapseCycle > 0){
      const idx = S.econHistory.findIndex(h=>h.cycle >= r.collapseCycle);
      if(idx >= 0){
        const x = PAD.left + (idx/(S.econHistory.length-1))*cW;
        ctx.strokeStyle = hexA(r.color, 0.3);
        ctx.lineWidth = 1; ctx.setLineDash([2,3]);
        ctx.beginPath(); ctx.moveTo(x, PAD.top); ctx.lineTo(x, PAD.top+cH); ctx.stroke();
        ctx.setLineDash([]);
        ctx.fillStyle = hexA(r.color, 0.5);
        ctx.font = '10px sans-serif'; ctx.textAlign = 'center';
        ctx.fillText('üíÄ', x, PAD.top+8);
      }
    }
    if(r.regrowthCycle > 0){
      const idx = S.econHistory.findIndex(h=>h.cycle >= r.regrowthCycle);
      if(idx >= 0){
        const x = PAD.left + (idx/(S.econHistory.length-1))*cW;
        ctx.strokeStyle = 'rgba(160,232,112,0.25)';
        ctx.lineWidth = 1; ctx.setLineDash([2,3]);
        ctx.beginPath(); ctx.moveTo(x, PAD.top); ctx.lineTo(x, PAD.top+cH); ctx.stroke();
        ctx.setLineDash([]);
        ctx.font = '10px sans-serif'; ctx.textAlign = 'center';
        ctx.fillText('üå±', x, PAD.top+8);
      }
    }
  });

  // Draw each region's economy line with gradient fill underneath
  S.regions.forEach((r,ri)=>{
    if(S.econHistory.length < 2) return;
    const pts = S.econHistory.map((h,i)=>({
      x: PAD.left + (i/(S.econHistory.length-1))*cW,
      y: PAD.top + cH - ((h.pts[ri]-minV)/range)*cH
    }));

    // Gradient fill under line
    const grad = ctx.createLinearGradient(0, PAD.top, 0, PAD.top+cH);
    grad.addColorStop(0, hexA(r.color, 0.25));
    grad.addColorStop(1, hexA(r.color, 0.01));
    ctx.fillStyle = grad;
    ctx.beginPath();
    ctx.moveTo(pts[0].x, PAD.top+cH);
    pts.forEach(p=>ctx.lineTo(p.x,p.y));
    ctx.lineTo(pts[pts.length-1].x, PAD.top+cH);
    ctx.closePath(); ctx.fill();

    // Line
    ctx.strokeStyle = r.alive ? r.color : hexA(r.color, 0.4);
    ctx.lineWidth = r.alive ? 2.5 : 1.5;
    ctx.lineJoin = 'round';
    ctx.setLineDash(r.alive ? [] : [4,3]);
    ctx.beginPath();
    pts.forEach((p,i)=>i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));
    ctx.stroke();
    ctx.setLineDash([]);

    // Endpoint dot + value label
    const last = pts[pts.length-1];
    ctx.fillStyle = r.color;
    ctx.beginPath(); ctx.arc(last.x, last.y, 4, 0, Math.PI*2); ctx.fill();
    ctx.strokeStyle = 'rgba(6,8,16,0.9)'; ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.arc(last.x, last.y, 4, 0, Math.PI*2); ctx.stroke();

    // Value label at end
    const lastVal = S.econHistory[S.econHistory.length-1].pts[ri];
    ctx.fillStyle = r.color;
    ctx.font = `bold 10px 'Cinzel',serif`;
    ctx.textAlign = last.x > PAD.left+cW*0.85 ? 'right' : 'left';
    const lx = last.x > PAD.left+cW*0.85 ? last.x-7 : last.x+7;
    ctx.fillText(Math.round(lastVal), lx, last.y-6);
  });

  // Legend
  const legend = document.getElementById('graph-legend');
  if(legend.children.length === 0){
    S.regions.forEach(r=>{
      const chip = document.createElement('div');
      chip.style.cssText = `display:flex;align-items:center;gap:6px;font-family:'Cinzel',serif;font-size:10px;color:${r.color};`;
      chip.innerHTML = `<span style="width:20px;height:2.5px;background:${r.color};border-radius:2px;display:inline-block"></span>${r.name}`;
      legend.appendChild(chip);
    });
  }

  // Bottom stats bar
  const statsEl = document.getElementById('graph-stats');
  statsEl.innerHTML = S.regions.map(r=>{
    const pl = phaseLabel(r);
    const lastPts = Math.round(r.econPts);
    return `<div style="display:flex;align-items:center;gap:8px;background:rgba(0,0,0,0.4);border:1px solid ${hexA(r.color,0.3)};border-radius:6px;padding:6px 12px;">
      <span style="width:8px;height:8px;border-radius:50%;background:${r.color};flex-shrink:0;display:inline-block"></span>
      <span style="font-family:'Cinzel',serif;font-size:11px;color:${r.color};font-weight:700">${r.short}</span>
      <span style="font-family:'Cinzel',serif;font-size:14px;color:${r.color};font-weight:900">${lastPts}</span>
      <span style="font-size:10px;color:${r.econDelta>=0?'var(--ok)':'var(--danger)'};font-family:'Rajdhani',sans-serif">${r.econDelta>=0?'‚ñ≤':'‚ñº'}${Math.abs(Math.round(r.econDelta))}</span>
      <span style="font-size:10px;color:${pl.col};font-family:'Rajdhani',sans-serif">${pl.txt}</span>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function hexA(hex,a){
  if(!hex||hex.length<7) return `rgba(128,128,128,${a})`;
  const rv=parseInt(hex.slice(1,3),16),gv=parseInt(hex.slice(3,5),16),bv=parseInt(hex.slice(5,7),16);
  return `rgba(${rv},${gv},${bv},${a})`;
}
function pad(n){return n.toString().padStart(3,'0');}
function addLog(type,msg){
  const log=document.getElementById('evlog');
  const el=document.createElement('div');
  el.className='log-entry';
  el.innerHTML=`<span class="log-time">[${pad(S.cycle)}]</span><span class="${type}">${msg}</span>`;
  log.insertBefore(el,log.firstChild);
  while(log.children.length>120) log.removeChild(log.lastChild);
}
function showTab(id,el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('tab-'+id).classList.add('active');
}

// ‚îÄ‚îÄ SIM CONTROL ‚îÄ‚îÄ
const SPEEDS=[600,200,70],SPEED_LABELS=['1√ó','3√ó','8√ó'];let speedIdx=0;
function cycleSpeed(){
  speedIdx=(speedIdx+1)%SPEEDS.length;
  document.getElementById('speed-lbl').textContent=SPEED_LABELS[speedIdx];
  if(S.running){clearTimeout(S.timer);schedNext();}
}
function schedNext(){if(!S.running)return;S.timer=setTimeout(()=>{simStep();schedNext();},SPEEDS[speedIdx]);}
function toggleSim(){S.running?stopSim():startSim();}
function startSim(){
  S.running=true;
  document.getElementById('btn-start').textContent='‚è∏ PAUSE';
  document.getElementById('btn-start').className='btn danger';
  document.getElementById('sim-status-lbl').textContent='RUNNING';
  document.getElementById('sim-dot').style.background='var(--ok)';
  schedNext();
}
function stopSim(){
  S.running=false;clearTimeout(S.timer);
  document.getElementById('btn-start').textContent='‚ñ∂ BEGIN';
  document.getElementById('btn-start').className='btn primary';
  document.getElementById('sim-status-lbl').textContent='PAUSED';
  document.getElementById('sim-dot').style.background='var(--warn)';
}
function resetSim(){
  stopSim();initState();
  document.getElementById('evlog').innerHTML='<div class="log-entry"><span class="log-time">[000]</span><span class="li">WorldSim reset. Press BEGIN to restart.</span></div>';
  document.getElementById('t-leader').textContent='‚Äî';
  document.getElementById('ana-inner').innerHTML='<div class="ins-card"><div class="ins-bd" style="padding:20px;color:var(--dim);font-size:13px">Start the simulation to generate strategic analysis...</div></div>';
  document.getElementById('sim-status-lbl').textContent='STANDBY';
  document.getElementById('sim-dot').style.background='var(--dim)';
  updateUI();drawWorld();
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
updateUI();drawWorld();
</script>
</body>
</html>
